# zeabur:m_image_tag diy_god_rsshub:latest
# zeabur:m_image_tag browserless_chrome:latest
# zeabur:m_image_tag redis_redis_stack_server:latest

services:
  # 1. RSSHub 主服务
  rsshub:
    image: diygod/rsshub:latest
    restart: always
    ports:
      - "1200:1200"
    environment:
      NODE_ENV: production
      CACHE_TYPE: redis
      REDIS_URL: 'redis://redis:6379'
      PUPPETEER_WS_ENDPOINT: 'ws://browserless:3000'
      # 确保这里是你自己的复杂密码
      ACCESS_KEY: '6c4173d7e0dc4bba98b94033a219ca0d' 
      PUPPETEER_TIMEOUT: 20000
    depends_on:
      redis:
        condition: service_healthy
      browserless:
        condition: service_healthy
    # 新增的健康检查，确保rsshub自身也健康
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:1200/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # 2. Puppeteer/Browserless 服务
  browserless:
    image: browserless/chrome:latest
    restart: always
    # 新增的健康检查，确保浏览器服务已就绪
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # 3. Redis 缓存服务
  redis:
    image: redis/redis-stack-server:latest
    restart: always
    # 新增的健康检查，确保Redis服务已就绪
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 5s
